# Name: financial_conditions.yaml
# Author: Sebastian Sopola @ https://www.linkedin.com/in/sebastiansopola/
# Description: This file containts the blueprint to provide logic to evaluate financial conditions



blueprint:
  name: Assess financial conditions
  description: Output will be one of the following options; delay, preheat or agressive heat 
  domain: automation
  author: Sebastian Sopola @ https://www.linkedin.com/in/sebastiansopola/
  input:
    housekeep:
      name: House Keep Information
      icon: mdi:hoop-house
      description:  Assign person for notifications and critical alerts
      input:
        user:
          name: Housekeeper's phone
          description: This user is administrator of heating system
          selector:
            entity:
              filter:
    room_information:
      name: Room information
      icon: mdi:database
      description: These inputs provide relevant room information
      input:  
        room_name:
          name: Room Name
          description: The name of the room for which the process should be conducted
          selector:
            text:
        room_information:
          name: Room Information Sensor
          description: Sensor providing such as heating schedule, temperature and thermostats
          selector:
            entity:
              filter:
                domain: sensor
        heating_system_interface:
          name: Room Heating System Interface
          description: This is a sensor configured to control heating system program flow
          selector:
            entity:
              filter:
                domain: sensor
    electric_stock_market_price_information:
      name: Electric Stock Market Price Information
      icon: mdi:currency-eur
      description: Sensors providing electric stock market price information
      input:
        nordpool_sensor:
          name: Nordpool Integration Sensor
          description: Sensor for Nordpool integration
          selector:
            entity:
              filter:
                domain: sensor    
        electricity_stock_market_price_information:
          name: Electricity Stock Market Price Information
          description: Custom sensor providing details on electricity prices, trends and thresholds
          selector:
            entity:
              filter:
                domain: sensor
    general_data:
      name: General Data for Heating Process
      icon: mdi:import
      description: Inputs essential for proceeding with the heating process
      input:  
        heat_transfer_coefficient: 
          name: Heat Transfer Coefficient
          description: Sensor measuring the heat transfer coefficient
          selector:
            entity:
              filter:
                domain: sensor
        heat_transfer_time_factor:
          name: Heat Transfer Time Factor
          description: Sensor adjusting the heat loss based on outdoor temperature
          selector:
            entity:
              filter:
                domain: sensor
        outdoor_temperature:
          name: Outdoor Temperature Sensor
          description: Sensor for measuring the outdoor temperature
          selector:
            entity:
              filter:
                domain: sensor


mode: restart
max_exceeded: silent

variables:
  user: !input user
  room_name: !input room_name
  room_information: !input room_information
  heating_system_interface: !input heating_system_interface
  nordpool_sensor: !input nordpool_sensor
  electricity_stock_market_price_information: !input electricity_stock_market_price_information
  heat_transfer_coefficient: !input heat_transfer_coefficient
  heat_transfer_time_factor: !input heat_transfer_time_factor
  outdoor_temperature: !input outdoor_temperature

  # --------------------------------------------------------------
  # - Define derived variables in as is principle. No alteration -
  # --------------------------------------------------------------
  room_at_maximum_temperature: "{{ state_attr(heating_system_interface, 'room_conditions')['maximum_temperature_reached'] == 'on' }}"
  room_at_or_below_minimum_temperature: "{{ state_attr(heating_system_interface, 'room_conditions')['minimum_temperature_or_below']  == 'on' }}"
  room_between_minimum_and_maximum_temperature: "{{ state_attr(heating_system_interface, 'room_conditions')['between_min_max_temperature']  == 'on' }}"

# ---------------------------------------------------
# - Define all necessary variables to trigger scope -
# ---------------------------------------------------
trigger_variables:
  heating_system_interface: !input heating_system_interface
  

# ---------------------------------------------------------------
# - Check has heating system run till this point without errors -
# ---------------------------------------------------------------
trigger:
  - platform: template
    value_template: >
      {{ state_attr(heating_system_interface, 'room_conditions')['maximum_temperature_reached'] == 'on' or
         state_attr(heating_system_interface, 'room_conditions')['minimum_temperature_or_below'] == 'on' or
         state_attr(heating_system_interface, 'room_conditions')['between_min_max_temperature'] == 'on' }}


action:
  - service: system_log.write
    data:
      message: >
        Heating service financial situation process has started.

  # ------------------
  # - INIT VARIABLES -
  # ------------------
  - variables:
      price_trend: "{{ state_attr(electricity_stock_market_price_information, 'price_trend') }}"
      current_price: "{{ state_attr(nordpool_sensor, 'current_price') | float }}"
      price_unit: "{{  state_attr(nordpool_sensor, 'unit_of_measurement') }}"
      price_treshold: "{{ state_attr(electricity_stock_market_price_information, 'price_treshold') | float }}"


      room_interface_status: "{{ states(room_information) }}"
      room_temperature: "{{ state_attr(room_information, 'room_temperature') | float }}"
      room_minimum_temperature: "{{ state_attr(room_information, 'room_minimum_temperature') | float }}"
      room_maximum_temperature: "{{ state_attr(room_information, 'room_maximum_temperature') | float }}"
      room_target_temperature: "{{ state_attr(room_information, 'room_target_temperature') | float }}"
      room_living_space: "{{ state_attr(room_information, 'room_living_space') | float }}"


      outdoor_temperature: "{{ states(outdoor_temperature) | float }}"
      heat_transfer_coefficient: "{{ states(heat_transfer_coefficient) | float }}"
      heat_transfer_time_factor: "{{ states(heat_transfer_time_factor) | float }}"


      price_category_expensive: "{{ state_attr(nordpool_sensor, 'current_price') | float > state_attr(electricity_stock_market_price_information, 'average_price') | float }}"
      price_category_average: "{{ state_attr(nordpool_sensor, 'current_price') | float == state_attr(electricity_stock_market_price_information, 'average_price') | float }}"
      price_category_cheap: "{{ state_attr(nordpool_sensor, 'current_price') | float < state_attr(electricity_stock_market_price_information, 'average_price') | float }}"
      
      
      price_trend_expensive: "{{ price_trend == 'expensive' }}"
      price_trend_average: "{{ price_trend == 'average' }}"
      price_trend_cheap: "{{ price_trend == 'cheap' }}"


      delay_heat: "{{ 'input_boolean.' + room_name | lower + '_delay_heat' }}"
      minimum_heat: "{{ 'input_boolean.' + room_name | lower + '_minimum_heat' }}"
      maintain_heat: "{{ 'input_boolean.' + room_name | lower + '_maintain_heat' }}"
      preheat_maximum: "{{ 'input_boolean.' + room_name | lower + '_preheat_maximum' }}"

  
  - choose:
      # --------------------------
      # - Room temperature check -
      # --------------------------
      - conditions:
          - condition: template
            value_template: "{{ room_at_maximum_temperature }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ delay_heat }}"


      # --------------------------
      # - Room temperature check -
      # --------------------------
      - conditions:
          - condition: template
            value_template: "{{ room_at_or_below_minimum_temperature }}"
        sequence:
          - choose:
              # -------------------------------------------
              # - Current price is categorised: expensive -
              # -------------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_expensive }}"



                # --------------------------------------------------------------
                # - Send confirm and dismiss notification to user -
                # --------------------------------------------------------------
                #### https://companion.home-assistant.io/docs/notifications/actionable-notifications/
                #### https://www.youtube.com/watch?v=v8fcwhko1k4
                # --------------------------------------------------------------
                # - Ask user to respond to high price and low room temperature -
                # --------------------------------------------------------------
                sequence:
                  - service: notify.{{ user }}
                    data:
                      title: >
                        Huom! Korkea sähkön hinta
                      message: >
                        Hinta: {{ current_price }} {{ price_unit }}. 
                        Huone {{ room_name }} on {{ room_temperature }}°C. 
                        Laske lämmitysrajaa? Nykyinen minimi: {{ room_minimum_temperature }}°C. 
                        Reagoi 5 minuutin sisällä.
                  #- delay: "00:05:00"  # 5 minutes # 
                  - delay: '00:00:10' # DELAY IS NOT WORKING SO DELAY IS NOT WORKING AT ALL!!!!!!!!!
                  - choose:
                      # -------------------------------------------------------------
                      # - User response; minimum temperature level has been lowered -
                      # -------------------------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ room_minimum_temperature < room_temperature }}"
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: >
                                {{ delay_heat }}
                          - service: system_log.write
                            data:
                              message: >
                                Heating has been delayed.
                      # ---------------------------------------------------------
                      # - User response; turned off automated heating --> Delay -
                      # ---------------------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ room_interface_status }}" 
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: >
                                {{ delay_heat }}  
                      # ------------------------------------------
                      # - User response; Nada --> therefore heat -
                      # ------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ state_attr(room_information, 'room_minimum_temperature') | float >= state_attr(room_information, 'room_temperature') | float }}" # Re-evaluate
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: >
                                {{ minimum_heat }}
              # -----------------------------------------
              # - Current price is categorised: average -
              # -----------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_average }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: >
                        {{ maintain_heat }}
              # ---------------------------------------
              # - Current price is categorised: cheap -
              # ---------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_cheap }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: >
                        {{ preheat_maximum }}
      # --------------------------
      # - Room temperature check -
      # --------------------------
      - conditions:
          - condition: template
            value_template: "{{ room_between_minimum_and_maximum_temperature }}"
        sequence:
          - choose:
              # -------------------------------------------
              # - Current price is categorised: expensive -
              # -------------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_expensive }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: >
                        Price is expensive.
                  - choose:
                      # -------------------------------------------------
                      # - Current price trend is categorised: expensive -
                      # -------------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_expensive }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is expensive.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # --------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        - choose:
                                                            # --------------------------------------------------
                                                            # - Next best case: price is still below price cap -
                                                            # --------------------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price < price_treshold }}"
                                                              sequence:
                                                                # -----------------
                                                                # - Maintain heat -
                                                                # -----------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ minimum_heat }}
                                                            # -----------------------------------------
                                                            # - Worst case: price is really expensive -
                                                            # -----------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price >= price_treshold }}"
                                                              sequence:
                                                                # --------------
                                                                # - Delay heat -
                                                                # --------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ delay_heat }}
                          # ---------------------------------------------------------------- 
                          # - Resolve conflict when both minimum heat and delay heat is on -
                          # ----------------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(minimum_heat) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ minimum_heat }}
                      # -----------------------------------------------
                      # - Current price trend is categorised: average -
                      # -----------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_average }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is average.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # --------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        - choose:
                                                            # --------------------------------------------------
                                                            # - Next best case: price is still below price cap -
                                                            # --------------------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price < price_treshold }}"
                                                              sequence:
                                                                # ----------------
                                                                # - Minimum heat -
                                                                # ----------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ minimum_heat }}
                                                            # -----------------------------------------
                                                            # - Worst case: price is really expensive -
                                                            # -----------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price >= price_treshold }}"
                                                              sequence:
                                                                # --------------
                                                                # - Delay heat -
                                                                # --------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ delay_heat }}
                          # ---------------------------------------------------------------- 
                          # - Resolve conflict when both minimum heat and delay heat is on -
                          # ----------------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(minimum_heat) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ minimum_heat }}
                      # ---------------------------------------------
                      # - Current price trend is categorised: cheap -
                      # ---------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_cheap }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is cheap.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # --------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        - choose:
                                                            # --------------------------------------------------
                                                            # - Next best case: price is still below price cap -
                                                            # --------------------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price < price_treshold }}"
                                                              sequence:
                                                                # ----------------
                                                                # - Minimum heat -
                                                                # ----------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ minimum_heat }}
                                                            # -----------------------------------------
                                                            # - Worst case: price is really expensive -
                                                            # -----------------------------------------
                                                            - conditions:
                                                                - condition: template
                                                                  value_template: "{{ current_price >= price_treshold }}"
                                                              sequence:
                                                                # --------------
                                                                # - Delay heat -
                                                                # --------------
                                                                - service: input_boolean.turn_on
                                                                  target:
                                                                    entity_id: >
                                                                      {{ delay_heat }}
                          # ---------------------------------------------------------------- 
                          # - Resolve conflict when both minimum heat and delay heat is on -
                          # ----------------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(minimum_heat) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ minimum_heat }}
              # -----------------------------------------
              # - Current price is categorised: average -
              # -----------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_average }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: >
                        Price is average.
                  - choose:
                      # -------------------------------------------------
                      # - Current price trend is categorised: expensive -
                      # -------------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_expensive }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is expensive.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # -------------------------------------------------------------------------------------------------
                                                        # - Turn on preheat. Both will be sometiems turned on. Later preheat is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- -------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ preheat_maximum }}
                          # ----------------------------------------------------------- 
                          # - Resolve conflict when both preheat and delay heat is on -
                          # -----------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(preheat_maximum) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ preheat_maximum }} 
                      # -----------------------------------------------
                      # - Current price trend is categorised: average -
                      # -----------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_average }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is average.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # --------------------------------------------------------------------------------------------------------
                                                        # - Turn on maintain heat. Both will be sometiems turned on. Later maintain is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- --------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ maintain_heat }}                         
                          # ----------------------------------------------------------------- 
                          # - Resolve conflict when both maintain heat and delay heat is on -
                          # -----------------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(maintain_heat) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ maintain_heat }}
                      # ---------------------------------------------
                      # - Current price trend is categorised: cheap -
                      # ---------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_cheap }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is cheap.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # --------------------------------------------------------------------------------------------------------
                                                        # - Turn on maintain heat. Both will be sometiems turned on. Later maintain is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- --------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ maintain_heat }}
                          # ----------------------------------------------------------------- 
                          # - Resolve conflict when both maintain heat and delay heat is on -
                          # -----------------------------------------------------------------                                       
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ states(maintain_heat) == 'on' }}"
                                  - condition: template
                                    value_template: "{{ states(delay_heat) == 'on' }}"
                                sequence:
                                  - service: system_log.write
                                    data:
                                      message: > 
                                        Resolving conflit of heating plan.
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: >
                                        {{ maintain_heat }}
              # ---------------------------------------
              # - Current price is categorised: cheap -
              # ---------------------------------------
              - conditions:
                  - condition: template
                    value_template: "{{ price_category_cheap }}"
                sequence:
                  - service: system_log.write
                    data:
                      message: >
                        Price is cheap.
                  - choose:
                      # --------------------------------------------------
                      # - Current price trend is categorised: expensivee -
                      # --------------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_expensive }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is expensive.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # -------------------------------------------------------------------------------------------------
                                                        # - Turn on preheat. Both will be sometiems turned on. Later preheat is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- -------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ preheat_maximum }}
                          # ----------------------------------------------------------- 
                          # - Resolve conflict when both preheat and delay heat is on -
                          # -----------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(preheat_maximum) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ preheat_maximum }}                          
                      # -----------------------------------------------
                      # - Current price trend is categorised: average -
                      # -----------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_average }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is average.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # --------------------------------------------------------------------------------------------------------
                                                        # - Turn on maintain heat. Both will be sometiems turned on. Later maintain is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- --------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ maintain_heat }}                         
                          # ----------------------------------------------------------------- 
                          # - Resolve conflict when both maintain heat and delay heat is on -
                          # -----------------------------------------------------------------                                       
                          - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ states(maintain_heat) == 'on' }}"
                                - condition: template
                                  value_template: "{{ states(delay_heat) == 'on' }}"
                              sequence:
                                - service: system_log.write
                                  data:
                                    message: > 
                                      Resolving conflit of heating plan.
                                - service: input_boolean.turn_off
                                  target:
                                    entity_id: >
                                      {{ maintain_heat }}
                      # ---------------------------------------------
                      # - Current price trend is categorised: cheap -
                      # ---------------------------------------------
                      - conditions:
                          - condition: template
                            value_template: "{{ price_trend_cheap }}"
                        sequence:
                          - service: system_log.write
                            data:
                              message: >
                                Price trend is cheap.
                          # -------------------------------------
                          # - Search cheaper price than current -
                          # -------------------------------------
                          - repeat:
                              count: 8
                              sequence:
                                # ------------------------------
                                # - Loop through future prices -
                                # ------------------------------
                                - variables:
                                    hour: "{{ ((now().hour + repeat.index) % 24) }}"
                                    price: >
                                      {% set hour_offset = (now().hour + repeat.index) %}
                                      {% if hour_offset < 24 %}
                                        {{ (state_attr(nordpool_sensor, 'today')[hour_offset]) | float }}  
                                      {% else %}
                                        {% if state_attr(nordpool_sensor, 'tomorrow_valid') %}
                                          {{ (state_attr(nordpool_sensor, 'tomorrow')[hour_offset - 24]) | float }}  
                                        {% else %}
                                          100
                                        {% endif %}
                                      {% endif %}
                                # ---------------------------------------------------
                                # - Start to assess the current price in assessment -
                                # ---------------------------------------------------
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ price != 100.0 }}"  # Skip invalid prices
                                      sequence:
                                        - choose:
                                            # -------------------------------------
                                            # - Check is the future price cheaper -
                                            # -------------------------------------
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ price < current_price }}"
                                              sequence:
                                                # --------------------------------------------------------------------------------------------
                                                # - Calculate necessary values for assessing whether room can sustain heat till cheaper hour -
                                                # - ------------------------------------------------------------------------------------------
                                                - variables:
                                                    heat_loss: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_temperature - outdoor_temperature) * (heat_transfer_time_factor * repeat.index) }}
                                                    heat_requirement: >
                                                      {{ heat_transfer_coefficient * room_living_space * (room_target_temperature - room_temperature) }}
                                                    estimated_room_temperature: >
                                                      {{ room_temperature - (heat_loss / (heat_transfer_coefficient * room_living_space)) }}

                                                - service: system_log.write
                                                  data:
                                                    message: >      
                                                      Room minimum temperature: {{ room_minimum_temperature }}
                                                      Estimated room temperature: {{ estimated_room_temperature | round(2) }}
                                                      Comparison: {{ estimated_room_temperature >= room_minimum_temperature }}
                                                # --------------------------------------------------
                                                # - Assess can room sustain current heat till then -
                                                # - ------------------------------------------------
                                                - choose:
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature >= room_minimum_temperature }}"
                                                      sequence:
                                                        # -----------------------------------------------------------------------------
                                                        # - Delay as room is expected to be capable to sustain heat till cheaper hour -
                                                        # -----------------------------------------------------------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                            entity_id: >
                                                              {{ delay_heat }}
                                                    - conditions:
                                                        - condition: template
                                                          value_template: "{{ estimated_room_temperature < room_minimum_temperature }}"
                                                      sequence:
                                                        # --------------------------------------------------------------------------------------------------------
                                                        # - Turn on maintain heat. Both will be sometiems turned on. Later maintain is turned off if delay is on -
                                                        # ----------------------------------------------------------------------------- --------------------------
                                                        - service: input_boolean.turn_on
                                                          target:
                                                              entity_id: >
                                                                {{ maintain_heat }}
                          # ----------------------------------------------------------------- 
                          # - Resolve conflict when both maintain heat and delay heat is on -
                          # -----------------------------------------------------------------                                       
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ states(maintain_heat) == 'on' }}"
                                  - condition: template
                                    value_template: "{{ states(delay_heat) == 'on' }}"
                                sequence:
                                  - service: system_log.write
                                    data:
                                      message: > 
                                        Resolving conflit of heating plan.
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: >
                                        {{ maintain_heat }}
  - service: system_log.write
    data:
      message: >
        Heating service financial situation process has finished.