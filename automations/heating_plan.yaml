
- id: generate
  alias: "Generate"
  trigger:
    - platform: template
      value_template: >
        {% set trigger_time = states('input_datetime.heat_control_estimation_moment') %}
        {% if trigger_time %}
          {% set hour, minute, second = trigger_time.split(':') %}
          {% set now = now().strftime('%H:%M:%S') %}
          {{ now == (hour ~ ':' ~ minute ~ ':' ~ second) }}
        {% else %}
          false
        {% endif %}

  
  variables:

    # Set up nordpool electric prices for calculation
    prices: "{{ states('sensor.tomorrow_prices') }}"
      
    # Set up average price for calculation
    average_price: "{{ states('sensor.average_tomorrow_price') | float }}"

    # Set up target temperature range and reference temperature
    minimum_temperature: "{{ states('input_number.minimum_temperature') | float }}"
    maximum_temperature: "{{ states('input_number.maximum_temperature') | float }}"
    target_temperature: "{{ states('input_number.target_temperature') | float }}"

    # Retrieve heat loss per room
    kitchen_heat_loss: "{{ states('sensor.kitchen_heat_loss') | float }}"
    bedroom_heat_loss: "{{ states('sensor.bedroom_heat_loss') | float }}"
    living_room_heat_loss: "{{ states('sensor.living_room_heat_loss') | float }}"
    main_bedroom_heat_loss: "{{ states('sensor.main_bedroom_heat_loss') | float }}"
    guest_bedroom_heat_loss: "{{ states('sensor.guest_bedroom_heat_loss') | float }}"

    # Retrieve heat requirement per room 
    kitchen_heat_requirement: "{{ states('sensor.kitchen_heat_requirement') | float }}"
    bedroom_heat_requirement: "{{ states('sensor.bedroom_heat_requirement') | float }}"
    living_room_heat_requirement: "{{ states('sensor.living_room_heat_requirement') | float }}"
    main_bedroom_heat_requirement: "{{ states('sensor.main_bedroom_heat_requirement') | float }}"
    guest_bedroom_heat_requirement: "{{ states('sensor.guest_bedroom_heat_requirement') | float }}"


    # Calculate the most cost effective hours
    cheap_tomorrow_prices: "{{ states('sensor.cheap_tomorrow_prices') }}"
    


    # Caculate the heat instructions next
    
    # sensor to do the thermostat setting logic !!!!

  action:
    - variables:
        rooms: 
          - kitchen
          - bedroom
          - living_room
          - main_bedroom
          - guest_bedroom
        heater_capacity: 0.6  # kWh per hour for 600W heaters
    
    - repeat:
      count: "{{ rooms | length }}"
      sequence:
        - variables:
          room_name: "{{ rooms[repeat.index -1] }}"
          room_heat_requirement: "{{  }}"
          number_of_cheap_hours: "{{ cheap_tomorrow_prices | length }}"
          heat_per_hour: "{{ room_heat_requirement / number_of_cheap_hours }}"
          set_thermostat: >
            {% set thermostat_setting = (heat_per_hour / heater_capacity) * 100 %}
            {% set target_temp = target_temperature %}  # Assuming target_temperature is defined
            {% if thermostat_setting > 100 %}
              100  # Cap thermostat at 100%
            {% else %}
              {% set calculated_temp = target_temp + (thermostat_setting / 100) * (35 - target_temp) %}
              {% if calculated_temp < 5 %}
                5  # Minimum thermostat setting
              {% elif calculated_temp > 35 %}
                35  # Maximum thermostat setting
              {% else %}
                {{ calculated_temp | round(0) }}
              {% endif %}
            {% endif %}



    - service: system_log.write
      data:
        message: >
          Tomorrow prices: {{ prices }}
          Average price: {{ average_price }}
          Minimum temperature: {{ minimum_temperature }}
          Maximum temperature: {{ maximum_temperature }}
          Target Temperature: {{ target_temperature }}

          Kitchen Heat Loss: {{ kitchen_heat_loss }}
          Bedroom Heat Loss: {{ bedroom_heat_loss }}
          Living Room Heat Loss: {{ living_room_heat_loss }}
          Main Bedroom Heat Loss: {{ main_bedroom_heat_loss }}
          Guest Bedroom Heat Loss: {{ guest_bedroom_heat_loss }}

          Kitchen Heat Requirement: {{ kitchen_heat_requirement }}
          Bedroom Heat Requirement: {{ bedroom_heat_requirement }}
          Living Room Heat Requirement: {{ living_room_heat_requirement }}
          Main Bedroom Heat Requirement: {{ main_bedroom_heat_requirement }}
          Guest bedroom heat requirement: {{ guest_bedroom_heat_requirement }}
        level: info






    # Based on cost effective n-number of hours and reading current indoor temperature and tomorrow's outdoor temperature. 
    # Calculate how much needs to be heated during those cost-effectice hours.